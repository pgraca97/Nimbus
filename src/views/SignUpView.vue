<template>
  <!-- Main container for the forms -->
  <div class="page-wrapper">
    <!-- Decorative SVGs -->
    <div class="stars-wrapper">
      <svg class="star-large" width="165" height="185" viewBox="0 0 165 185" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g clip-path="url(#clip0_92_1240)">
          <mask id="mask0_92_1240" style="mask-type:luminance" maskUnits="userSpaceOnUse" x="0" y="0" width="110" height="149">
            <path d="M110 0H0V149H110V0Z" fill="white"/>
          </mask>
          <g mask="url(#mask0_92_1240)">
            <mask id="mask1_92_1240" style="mask-type:luminance" maskUnits="userSpaceOnUse" x="0" y="0" width="110" height="149">
              <path d="M110 0H0V149H110V0Z" fill="white"/>
            </mask>
            <g mask="url(#mask1_92_1240)">
              <path d="M87.4673 88.8819L101.61 106.402C103.075 108.191 102.782 110.835 100.998 112.304C100.625 112.598 100.199 112.838 99.7457 112.999C97.1622 113.933 94.6852 113.346 92.2615 111.236C85.2833 105.12 78.3317 99.3779 71.4068 93.9563C70.7409 93.4221 69.7821 93.529 69.2227 94.1967C69.0363 94.437 68.9031 94.7308 68.9031 95.0513L64.6949 145.047C64.4818 147.424 62.4043 149.187 60.0072 148.973C59.8208 148.973 59.6344 148.92 59.4746 148.893C55.3995 148.012 53.3486 144.941 53.2954 139.706C53.1622 128.783 52.4431 116.337 51.0847 102.342L50.3922 94.8643C50.3123 93.9563 49.5133 93.3153 48.6077 93.3954C48.2348 93.4221 47.862 93.6091 47.5956 93.8762L27.5133 114.334C25.5157 116.364 22.3196 116.577 20.0823 114.815C17.0993 112.491 16.6465 109.66 18.7506 106.348C23.891 98.1226 29.937 90.8582 36.8886 84.5286C37.6876 83.8075 37.7675 82.579 37.0484 81.7778C36.7288 81.4039 36.276 81.1902 35.7966 81.1368L3.99513 77.6381C1.89102 77.3978 0.612567 76.2226 0.186417 74.1128C-0.452809 70.8545 0.346223 66.3676 4.26148 65.7C14.5956 63.964 24.184 63.1628 33.0532 63.2963C34.4382 63.323 35.6101 62.228 35.6634 60.8392C35.6634 60.1716 35.4237 59.5306 34.9709 59.0231C30.4697 54.1357 26.7409 48.8477 23.8111 43.159C22.6658 40.9423 23.5181 38.1915 25.7288 37.043C25.8353 36.9896 25.9419 36.9362 26.0484 36.8828C28.3922 35.8946 30.5496 36.3487 32.5472 38.1915C36.0363 41.4497 39.5254 44.8149 42.9612 48.2601C43.7869 49.1147 45.1719 49.1147 46.0242 48.2601C46.2639 48.0197 46.4237 47.7527 46.5302 47.4322C51.5109 33.0904 44.8256 13.2468 55.5593 0.801244C56.2252 0.0534395 57.2639 -0.240341 58.2227 0.106854C60.9927 1.14844 62.5908 3.47197 62.9903 7.10417C64.5085 20.5913 64.8014 34.1854 63.8959 47.8328C63.816 48.9812 64.6683 49.9961 65.8402 50.1029C66.3462 50.1296 66.8256 49.9961 67.2252 49.7023C74.8426 44.254 82.6198 39.1529 90.5569 34.3723C93.6465 32.5295 96.1767 33.1972 98.121 36.4021C99.1598 38.1113 98.9467 40.3013 97.5884 41.7702C92.0218 47.8328 85.4963 53.5214 78.0121 58.8362C77.1332 59.4772 76.9467 60.679 77.5859 61.5603C77.8789 61.9609 78.3317 62.2547 78.8111 62.3348C88.799 64.0174 97.2954 62.1212 107.177 66.2074C109.494 67.1689 110.586 69.8396 109.627 72.1898C109.467 72.5904 109.254 72.9376 108.988 73.2848C107.257 75.5015 104.833 76.5698 101.743 76.5431C95.5109 76.463 89.4382 77.0506 83.5254 78.3058C81.9007 78.6797 80.8353 80.2822 81.2082 81.9113C81.2881 82.2852 81.4479 82.6591 81.661 82.9796C83.1525 85.1429 85.0968 87.0925 87.4673 88.8552" fill="#F2DB76"/>
            </g>
          </g>
        </g>
        <g clip-path="url(#clip1_92_1240)">
          <mask id="mask2_92_1240" style="mask-type:luminance" maskUnits="userSpaceOnUse" x="110" y="110" width="55" height="75">
            <path d="M165 110H110V185H165V110Z" fill="white"/>
          </mask>
          <g mask="url(#mask2_92_1240)">
            <mask id="mask3_92_1240" style="mask-type:luminance" maskUnits="userSpaceOnUse" x="110" y="110" width="55" height="75">
              <path d="M165 110H110V185H165V110Z" fill="white"/>
            </mask>
            <g mask="url(#mask3_92_1240)">
              <path d="M153.734 154.739L160.805 163.558C161.538 164.459 161.391 165.79 160.499 166.529C160.312 166.677 160.099 166.798 159.873 166.878C158.581 167.349 157.343 167.053 156.131 165.991C152.642 162.913 149.166 160.022 145.703 157.293C145.37 157.025 144.891 157.078 144.611 157.414C144.518 157.535 144.452 157.683 144.452 157.845L142.347 183.01C142.241 184.207 141.202 185.094 140.004 184.987C139.91 184.987 139.817 184.96 139.737 184.946C137.7 184.503 136.674 182.957 136.648 180.322C136.581 174.823 136.222 168.559 135.542 161.515L135.196 157.75C135.156 157.293 134.757 156.971 134.304 157.011C134.117 157.025 133.931 157.119 133.798 157.253L123.757 167.551C122.758 168.572 121.16 168.68 120.041 167.793C118.55 166.623 118.323 165.198 119.375 163.531C121.946 159.391 124.969 155.734 128.444 152.548C128.844 152.185 128.884 151.567 128.524 151.163C128.364 150.975 128.138 150.868 127.898 150.841L111.998 149.08C110.946 148.959 110.306 148.367 110.093 147.305C109.774 145.665 110.173 143.407 112.131 143.07C117.298 142.197 122.092 141.793 126.527 141.861C127.219 141.874 127.805 141.323 127.832 140.624C127.832 140.288 127.712 139.965 127.485 139.71C125.235 137.249 123.37 134.588 121.906 131.724C121.333 130.609 121.759 129.224 122.864 128.646C122.918 128.619 122.971 128.592 123.024 128.565C124.196 128.068 125.275 128.296 126.274 129.224C128.018 130.864 129.763 132.558 131.481 134.292C131.893 134.722 132.586 134.722 133.012 134.292C133.132 134.171 133.212 134.037 133.265 133.875C135.755 126.656 132.413 116.668 137.78 110.403C138.113 110.027 138.632 109.879 139.111 110.054C140.496 110.578 141.295 111.748 141.495 113.576C142.254 120.365 142.401 127.207 141.948 134.077C141.908 134.655 142.334 135.166 142.92 135.22C143.173 135.233 143.413 135.166 143.613 135.018C147.421 132.275 151.31 129.708 155.278 127.301C156.823 126.374 158.088 126.71 159.061 128.323C159.58 129.184 159.473 130.286 158.794 131.025C156.011 134.077 152.748 136.94 149.006 139.616C148.567 139.938 148.473 140.543 148.793 140.987C148.939 141.188 149.166 141.336 149.406 141.377C154.4 142.224 158.648 141.269 163.588 143.326C164.747 143.81 165.293 145.154 164.814 146.337C164.734 146.539 164.627 146.714 164.494 146.888C163.628 148.004 162.416 148.542 160.872 148.528C157.755 148.488 154.719 148.784 151.763 149.416C150.95 149.604 150.418 150.41 150.604 151.23C150.644 151.419 150.724 151.607 150.83 151.768C151.576 152.857 152.548 153.838 153.734 154.726" fill="#F2DB76"/>
            </g>
          </g>
        </g>
        <defs>
          <clipPath id="clip0_92_1240">
            <rect width="110" height="149" fill="white"/>
          </clipPath>
          <clipPath id="clip1_92_1240">
            <rect width="55" height="75" fill="white" transform="translate(110 110)"/>
          </clipPath>
        </defs>
      </svg>
    </div>

    <div class="green-hill">
      <svg width="571" height="313" viewBox="0 0 571 313" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g clip-path="url(#clip0_466_867)">
          <mask id="mask0_466_867" style="mask-type:luminance" maskUnits="userSpaceOnUse" x="0" y="0" width="578" height="322">
            <path d="M578 0H0V322H578V0Z" fill="white"/>
          </mask>
          <g mask="url(#mask0_466_867)">
            <mask id="mask1_466_867" style="mask-type:luminance" maskUnits="userSpaceOnUse" x="0" y="0" width="578" height="322">
              <path d="M578 0H0V322H578V0Z" fill="white"/>
            </mask>
            <g mask="url(#mask1_466_867)">
              <path d="M577.255 213.754V153.457C577.255 28.182 468.917 35.5013 468.917 35.5013C437.822 35.5013 412.985 48.3972 395.798 69.0606C372.551 0.946179 302.511 -0.746723 289 0.14952C219.606 4.63073 182.848 70.3054 194.223 144.445C148.971 92.5123 100.489 98.9354 100.489 98.9354C37.4041 98.9354 0 152.063 0 215.298V322H578L577.255 213.754Z" fill="#35624D"/>
            </g>
          </g>
        </g>
        <defs>
          <clipPath id="clip0_466_867">
            <rect width="578" height="322" fill="white"/>
          </clipPath>
        </defs>
      </svg>
    </div>

    <div class="form-wrapper" ref="formWrapper">
      <!-- signup form wrapper -->
      <!-- Conditionally render the first or second form -->
      <main class="sign-up form" ref="signUpForm">
        <!-- Form element with submit event handler -->
        <form @submit.prevent="signUp">
          <!-- Title for the signup form -->
          <h1>Create Account</h1>
          <InputField
          id="email"
          placeholder="email"
          v-model="email"
          required
          />
          <InputField
          id="username"
          placeholder="username"
          v-model="username"
          required
          />
          <InputField
          id="passwordInput"
          type="password"
          placeholder="password"
          v-model="password"
          required
          />
          <InputField
          id="passwordInput"
          type="password"
          placeholder="confirm password"
          v-model="passwordConfirmation"
          required
          />
          <div class="terms-checkbox">
            <input type="checkbox" id="terms" v-model="agreedToTerms" >
            <label for="terms">
              I agree to Nimbu's <a href="/terms" target="_blank">Terms & Conditions</a> and acknowledge the <a href="/privacy" target="_blank">Privacy Policy</a>.
            </label>
          </div>
          <div class="buttons-row">
            <!-- signup submission button -->
            <CustomButton
            buttonType="submit"
            buttonText="Sign Up"
            />
            <!-- Social signup options -->
            <CustomButton
            buttonClass="google social-sign-up"
            iconSrc="google"
            />
            <CustomButton
            buttonClass="apple social-sign-up"
            iconSrc="apple"
            />
          </div>
          <!-- Container for error messages -->
          <ErrorMessage :message="errorMessage" @clear-error="handleClearError" />
          <!-- Link to log-in page -->
          <ActionLink preText="Already have an account?" text="Log In" @handleClick="goToLogIn" />
        </form>
      </main>
    </div>

    
  </div>
  <div class="personalization form-wrapper" ref="persFormWrapper">
      <main class="personalization form" ref="personalizationForm">
        <form @submit.prevent="persSave">
          <h1>Make Nimbus truly yours!</h1>
          <div class="personalization-form-wrapper">
            <div class="personalization-area">
              <div
                class="personalization-container"
                v-for="area in 4"
                :key="area"
                :class="{ active: activeArea === area }"
              >
                <div v-if="area === 1">
                  <h2>Weather Watchlist</h2>

                  <div class="search-input-wrapper">
    <InputField
      id="search"
      type="search"
      placeholder="search location"
      v-model="searchQuery"
      @focus="handleSearchBoxFocus"
      @add="handleAdd"
      style="margin: 0;"
    />
    <div v-if="searchResults.length" class="search-results-container">
      <div
        v-for="result in searchResults"
        :key="result.place_id"
        class="result-item"
        @click="selectPrediction(result)"
      >
        <span class="main-text">{{ result.structured_formatting.main_text }}</span>
        <span class="hyphen" v-if="result.structured_formatting.secondary_text">-</span>
        <span class="secondary-text">{{ result.structured_formatting.secondary_text }}</span>
      </div>
    </div>
  </div>
                  <AnimatedCircles
                    :selectedLocations="userLocations"
                    @remove-location="removeUserLocation"
                  />
                </div>

                <div v-else-if="area === 2">
                    <h2>Alert Preferences</h2>
                    <div class="preferences">
                        <button
                        type="button"
                        v-for="preference in ['Temperature', 'Wind', 'Moon Phases', 'Precipitation', 'Waves']"
                        :key="preference"
                        :class="{ selected: userPreferences.includes(preference) }"
                        @click="togglePreference(preference)"
                        >
                        {{ preference }}
                        </button>
                    </div>
                </div>

                <div v-else-if="area === 3">
                    <div class="gamification-header">
                        <h2>Allow Gamification</h2>
                        <div class="gamification-toggle" @click="toggleGamification" :class="{ 'on' : allowGamification }">
                        <div class="toggle-circle" :class="{ 'toggle-on': allowGamification }"></div>
                        </div>
                    </div>
                    <div class="gamification-content">
                        <div class="avatar-main">
                            <div class="default-avatar" :style="{ backgroundColor: defaultAvatarColor }">
                                </div>
                        </div>
                        <div class="avatar-options">
                            <div
                                v-for="(avatar, index) in avatars"
                                :key="index"
                                class="avatar-option"
                                :class="{ 'selected-avatar': selectedAvatar === avatar }"
                                @click="selectAvatar(avatar)"
                            >
                                <div class="avatar-circle" :style="{ backgroundColor: avatar }"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-else-if="area === 4">
                    <h2>Language and Region</h2>
                    <div class="language-selection">
                        <label class="section-label">Language</label>
                        <div class="languages">
                            <img :src="langIcon" class="lang-icon" />
                            <button type="button" @click="selectLanguage('pt')" :class="{ selected: userLang === 'pt' } " >PT</button>
                            <button type="button" @click="selectLanguage('en')" :class="{ selected: userLang === 'en' }">ENG</button>
                        </div>
                    </div>
                    <div class="region-detection">
                        <div class="region-label">
                            <label class="section-label">Region </label>
                            <button type="button" @click="fetchLocationNameFromOpenWeather">Detect Region</button>
                        </div>
                        <div class="region">
                            <img :src="regionIcon" class="lang-icon" />
                            <div class="userRegion">
                                <input
                                type="text"
                                disabled
                                :placeholder="userRegion ? userRegion.region : 'Select your region'"
                                :value="userRegion ? userRegion.region : ''"
                                class="region-input"
                                />
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </div>

            <div class="button-wrapper">
               <div class="arrow-button-wrapper">
                    <ArrowButton direction="up" button-class="personalization-arrow" @clickButton="handleUpClick" />
                    <ArrowButton direction="down" button-class="personalization-arrow" @clickButton="handleDownClick" />
                </div>
                <div class="s-button-wrapper">
                    <CustomButton
                    buttonType="submit"
                    buttonText="Save"
                    />
                    <CustomButton
                    buttonType="button"
                    buttonText="Skip"
                    @click="skipPersonalization"
                    />
                </div>
            </div>
          </div>

          <ErrorMessage :message="errorMessage" @clear-error="handleClearError" />
          <ActionLink preText="Prefer to dive in now? " text="Skip this form" @handleClick="skipPersonalization" />
        </form>
      </main>
    </div>
</template>


<script>
import InputField from '@/components/InputField.vue';
import CustomButton from '@/components/CustomButton.vue';
import ErrorMessage from '@/components/ErrorMessage.vue';
import ActionLink from '@/components/ActionLink.vue';
import ArrowButton from '@/components/ArrowButton.vue';
import AnimatedCircles from '@/components/AnimatedCircles.vue';
import { validateEmail, validatePassword, validateUsername, validatePasswordMatch  } from "@/utils.js";
// Ensure all necessary functions are imported
import {
    fetchPlaceDetails,
    reverseGeocodeOpenWeather,
    reverseGeocodeGoogle, // Keep if used elsewhere, otherwise remove
    getAutocompletePredictions,
    loadGoogleMapsAPI
} from "@/weatherService.js";

import langIcon from '@/assets/icons/world.svg';
import regionIcon from '@/assets/icons/region.svg';
// Import user store from Pinia
import { useUserStore } from '@/stores/user';

export default {
  data() {
    return {
      email: "",
      username: "",
      password: "",
      passwordConfirmation: "",
      errorMessage: "",
      agreedToTerms: false,
      activeArea: 1,
      userPreferences: [],
      allowGamification: false,
      selectedAvatar: null,
      avatars: ['#FF6347', '#4682B4', '#32CD32'],
      defaultAvatarColor: '#ddd',
      userLang: null,
      userRegion: null,
      searchQuery: '',
      searchResults: [],
      addedResults: [],
      userLocations: [],
      preferences: null,
      timeoutID: null,
      target: null, // Consider removing if unused
      isSelectingPrediction: false,
      langIcon,
      regionIcon,
      triedToleave: null, // Consider removing if unused
    };
  },
  components: {
    InputField,
    CustomButton,
    ErrorMessage,
    ActionLink,
    ArrowButton,
    AnimatedCircles,
  },
  computed: {
    store() {
      return useUserStore();
    }
  },
  watch: {
    // Keep existing watchers
     email() { this.handleClearError(); },
     username() { this.handleClearError(); },
     password() { this.handleClearError(); }, // Assuming v-model="password" exists
     passwordConfirmation() { this.handleClearError(); }, // Assuming v-model="passwordConfirmation" exists
     agreedToTerms() { this.handleClearError(); },
     searchQuery() {
        if (!this.isSelectingPrediction) {
            this.handleSearchInput();
        }
        // Removed the else block resetting isSelectingPrediction here,
        // it's better handled within selectPrediction's finally block
     },
  },
  mounted () {
    // Ensure API is loaded when component mounts
     loadGoogleMapsAPI().then(() => {
         console.log("Google Maps API ready for SignUpView component.");
     }).catch(error => {
         console.error("Failed to load Google Maps API in SignUpView:", error);
         this.errorMessage = "Could not load location services."; // Inform user
     });
  },
  methods: {
    handleSearchBoxFocus() {
      loadGoogleMapsAPI(); // Ensure API is loaded on focus as well
       // Reset token if user refocuses to start a new search session
       // Note: This might clear a token needed by a pending fetchPlaceDetails if user clicks away then back quickly.
       // Consider more robust session management if needed.
       // autocompleteSessionToken = null; // Accessing global token directly isn't ideal from component
       // Maybe add a function in weatherService to explicitly start/end sessions if needed
    },
    handleSearchInput() {
        clearTimeout(this.timeoutID);
        if (this.searchQuery === '') {
            this.searchResults = [];
            this.addedResults= [];
        } else {
            this.timeoutID = setTimeout(() => {
                this.fetchPredictions();
            }, 300);
        }
    },
    async fetchPredictions() {
        try {
            await loadGoogleMapsAPI(); // Ensure API ready
            if (this.searchQuery.length >= 1) {
                const predictions = await getAutocompletePredictions(this.searchQuery);
                this.searchResults = predictions; // Assign fetched predictions
                console.log("Fetched Predictions (raw):", predictions);
                console.log("Component searchResults updated:", this.searchResults);
            } else {
                this.searchResults = [];
            }
        } catch (error) {
            console.error('Error fetching predictions in component:', error);
            this.errorMessage = `Failed to fetch location suggestions: ${error.message || 'Unknown error'}`;
            this.searchResults = [];
        }
    },
    async selectPrediction(prediction) {
        console.log("selectPrediction called with:", prediction);
        if (!prediction || !prediction.place_id) {
             console.error("Invalid prediction object passed to selectPrediction:", prediction);
             this.errorMessage = "Invalid location selected.";
             return;
        }

        this.isSelectingPrediction = true; // Prevent watcher from re-fetching while we process
        this.searchQuery = prediction.description; // Update input field text
        this.searchResults = []; // Hide results list immediately

        try {
            // Fetch details (lat/lng) for the selected place
            console.log(`Fetching details for place_id: ${prediction.place_id}`);
            // Request specific fields needed: location, displayName
            const placeDetails = await fetchPlaceDetails(prediction.place_id, ['location', 'displayName']);

            // *** ADDED LOGGING AND CHECKS ***
            console.log('Inside selectPrediction - Fetched placeDetails:', placeDetails);

            if (placeDetails && placeDetails.location) {
                // Access lat/lng directly from the location literal
                const locationLatLong = {
    lat: placeDetails.location.lat(), // CALL the function lat()
    lng: placeDetails.location.lng(), // CALL the function lng()
};
console.log('Extracted Lat/Lng:', locationLatLong);

                // Stage the result to be added when user clicks "Add" button
                this.addedResults = [{
                    // Use displayName from fetched details for consistency
                    main_text: placeDetails.displayName || prediction.structured_formatting.main_text,
                    description: prediction.description, // Keep original description
                    place_id: prediction.place_id, // Include place_id for potential future use
                    ...locationLatLong
                }];
                console.log("Place selected and staged:", this.addedResults[0]);
                this.handleClearError(); // Clear any previous errors

            } else {
                 // This case handles if fetchPlaceDetails resolves but location is missing
                 console.error('placeDetails fetched successfully, but placeDetails.location is missing!', placeDetails);
                 this.errorMessage = "Could not get coordinates for the selected location.";
                 this.addedResults = []; // Clear staged results
                 this.searchQuery = ''; // Optionally clear search query
            }

        } catch (error) {
            console.error('Error in selectPrediction fetching/processing place details:', error);
            this.errorMessage = `Failed to get location details: ${error.message || 'Unknown error'}`;
            this.addedResults = []; // Clear staged results on error
            // Don't clear searchQuery here, user might want to see what they selected
        } finally {
             // Ensure the flag is reset AFTER the select logic finishes,
             // allowing v-model/watchers to settle.
             // Use setTimeout to push this to the end of the event loop queue.
             setTimeout(() => {
                 this.isSelectingPrediction = false;
                 console.log("isSelectingPrediction reset to false");
             }, 0);
        }
    },
    handleAdd() {
        if (this.addedResults.length === 0) {
            this.errorMessage = "Please select a location from the suggestions first.";
            return;
        }
        if (this.userLocations.length >= 4) {
            this.errorMessage = "Maximum of 4 locations can be added.";
            this.searchQuery = '';
            this.addedResults = [];
            return;
        }

        const selectedLocation = this.addedResults[0];
        // Check for duplicates based on place_id if available, otherwise description
        const uniqueId = selectedLocation.place_id || selectedLocation.description;
        if (!this.userLocations.some(loc => (loc.place_id || loc.description) === uniqueId)) {
          console.log("SignUpView - handleAdd: Pushing location:", JSON.stringify(selectedLocation, null, 2));
             this.userLocations.push(selectedLocation);
             console.log("Location added:", selectedLocation);
        } else {
             this.errorMessage = `${selectedLocation.main_text} is already in your watchlist.`;
        }

        this.addedResults = [];
        this.searchQuery = '';
        this.handleClearError();
    },
    removeUserLocation(index) {
        this.userLocations.splice(index, 1);
    },
    async signUp() {
        // ... (keep existing signUp logic) ...
         try {
            validateEmail(this.email);
            validateUsername(this.username);
            validatePassword(this.password);
            validatePasswordMatch(this.password, this.passwordConfirmation);
            if (!this.agreedToTerms) {
                throw new Error('You must agree to the Terms & Conditions and Privacy Policy.');
            }
            await this.store.register(this.email, this.username, this.password);
            this.$refs.signUpForm.classList.add('concluded');
            setTimeout(() => {
                this.$refs.persFormWrapper.classList.add('active');
                this.$refs.personalizationForm.classList.add('active');
            }, 300);
        } catch (error) {
            console.error("Sign up error:", error);
            this.errorMessage = error.message || "An unknown sign-up error occurred.";
        }
    },
    handleClearError() {
        this.errorMessage = "";
    },
    goToLogIn(event) {
        this.$router.push({ name: 'login' });
    },
    handleUpClick() {
        if (this.activeArea > 1) this.activeArea--;
    },
    handleDownClick() {
        if (this.activeArea < 4) this.activeArea++;
    },
    togglePreference(preference) {
        const index = this.userPreferences.indexOf(preference);
        if (index === -1) this.userPreferences.push(preference);
        else this.userPreferences.splice(index, 1);
    },
    toggleGamification() {
        this.allowGamification = !this.allowGamification;
    },
    selectAvatar(avatar) {
        this.selectedAvatar = avatar;
        this.defaultAvatarColor = avatar;
    },
    selectLanguage(lang) {
        this.userLang = (this.userLang === lang) ? null : lang;
    },
    fetchLocationNameFromOpenWeather() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    try {
                        const { latitude, longitude } = position.coords;
                        console.log(`Fetching region for: ${latitude}, ${longitude}`);
                        const result = await reverseGeocodeOpenWeather(latitude, longitude);
                        if (result.length > 0) {
                            this.userRegion = { latitude, longitude, region: result[0].name };
                            console.log('Region detected:', this.userRegion);
                        } else {
                             this.errorMessage = "Could not determine region name.";
                        }
                    } catch (error) {
                        console.error('Error fetching location name:', error);
                        this.errorMessage = "Could not determine region name.";
                    }
                },
                (error) => {
                    console.error('Geolocation permission error:', error);
                    this.errorMessage = `Could not get location: ${error.message}`;
                }
            );
        } else {
            this.errorMessage = "Geolocation is not supported by your browser.";
        }
    },
    async persSave() {
     // Get username safely - using this.username because store.user is null at this point
     const currentUsername = this.username;
     if (!currentUsername) {
       this.errorMessage = 'Username not found. Cannot save preferences.';
       console.error("persSave error: Username missing.");
       return;
     }

     // Perform checks like ensuring region is selected
     if (!this.userRegion) {
       this.activeArea = 4; // Focus the region area
       this.errorMessage = "Please select at least your region.";
       return;
     }
     this.handleClearError(); // Clear previous errors

     try {
       // *** CONSTRUCT THE PREFERENCES OBJECT CORRECTLY ***
       const preferencesToSave = {
         userRegion: this.userRegion,             // Get from component state
         userLocations: this.userLocations,         // Get from component state
         userPreferences: this.userPreferences,   // Get from component state
         allowGamification: this.allowGamification, // Get from component state
         selectedAvatar: this.selectedAvatar,       // Get from component state
         userLang: this.userLang,               // Get from component state
         // Include any other preferences you want to save
       };

       console.log('Attempting to save preferences for:', currentUsername);
       console.log('Preferences object being sent:', preferencesToSave); // Log what you're sending

       // Call the store action with the correct username and the constructed object
       console.log("SignUpView - persSave: Sending userLocations:", JSON.stringify(preferencesToSave.userLocations, null, 2));
       await this.store.savePreferences(currentUsername, preferencesToSave);

       console.log('Preferences supposedly saved for:', currentUsername);

       // Optional: Attempt auto-login here if desired (see previous answer)

       this.$router.push({ name: "landingPage" });

     } catch (error) {
       console.error("Error saving preferences:", error);
       this.errorMessage = error.message || "Failed to save preferences.";
     }
   },
    skipPersonalization() {
        // ... (keep existing skipPersonalization logic) ...
         if (!this.userRegion) {
             this.activeArea = 4;
             this.errorMessage = "Please select at least your region before skipping.";
             return;
         }
         this.$router.push({ name: "landingPage" });
    },
  },
};
</script>


<style scoped>
.page-wrapper {
  position: relative;
  width: 100vw;
  overflow: hidden;
  background-color: #EDDED4;
  display: flex;
  align-items: center;
  justify-content: center;
}

.stars-wrapper {
  position: absolute;
  top: 100px;
  left: 100px;
  z-index: 0;
}

.star-large {
  position: relative;
  transform: scale(1);
  opacity: 0.8;
}

.green-hill {
  position: fixed;
  bottom: -2px;
  right: -50px;
  z-index: 2;
  width: 30%;
  height: auto;
  pointer-events: none;
  transform: scale(1.1);
}

.green-hill svg {
  display: block;
  width: 100%;
  height: auto;
}

.form-wrapper {
  position: relative;
  z-index: 1;
  display: flex;
  align-items: center;
  justify-content: center;
}

.language-selection,
.region-detection {
  display: flex;
  flex-direction: column;
}

/* .language-buttons button:hover, .region-detection button:hover {
  background-color: #d0d0d0;
}
 */
 .personalization-area .active {
  border: none;
}
 .languages,
 .region {
  display: flex;
  flex-direction: row;
  justify-content: center;
  align-items: center;
 /*  margin-bottom: 10px; */
 }
 .languages img,
 .region img {
  width: 30px;
  height: 30px;
  margin-right: 5px;
 }
.languages button,
.region-label button{
  margin: 5px;
  padding: 10px;
  background-color: #f0f0f0; 
  border: 1px solid #303030;
  border-radius: 10px;
  cursor: pointer;
  color: #303030;

font-family: 'Asap Regular', sans-serif;
font-size: 1rem;
  transition: background-color 0.3s;
}

.region-input {
/*   flex-grow: 1; */
  width: fit-content;
  padding: 10px;
  border: 1px solid #303030;
  border-radius: 10px;
  background-color: #f9f9f9;
  color: #303030;
  font-family: 'Asap Regular', sans-serif;
font-size: 1rem;
}

.region-input::placeholder {
  color: #858585;
}

.region-input:disabled {
  background-color: #EDDED4;
}
.languages button:hover,
.region-label button:hover {
  background-color: #e7e7e7; 
}

.languages button.selected {
  background-color: #DFE287;; 
  color: #303030;
}

.section-label {
  font-weight: bold;
  margin-bottom: 10px;
}

/* .section-label:nth-child(1) {
  margin-top: 20px;
} */

.area-3-organizer {
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: space-between;
  width: 100%;
  padding: 2rem;
}
.gamification-options {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  justify-content: space-between;
  height: 100%;
}
.gamification-toggle {
  width: 50px;
  height: 25px;
  background-color: #ccc;
  border-radius: 15px;
  cursor: pointer;
  position: relative;
  transition: all 0.3s ease;
}

.toggle-circle {
  width: 20px;
  height: 20px;
  background-color: white;
  border-radius: 50%;
  position: absolute;
  top: 2.5px;
  left: 2.5px;
  transition: all 0.3s ease;
}

.toggle-on {
  transform: translateX(25px);
}

.gamification-toggle.on {
  background-color: #b4b4b4;
}


.default-avatar {
  width: 110px;
  height: 110px;
  border-radius: 50%;
  background-color: #303030;
}

.avatar-options div {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  cursor: pointer;
}

.avatar-options {
  display: flex;
}
/* .selected-avatar {
  border: 2px solid #4CAF50;
} */


.preferences button {
  margin: 5px;
  padding: 10px;
  background-color: #f0f0f0; 
  border: 1px solid #303030;
  border-radius: 10px;
  cursor: pointer;
  color: #303030;

font-family: 'Asap Regular', sans-serif;
font-size: 1rem;
  transition: background-color 0.3s;
}

.preferences button:hover {
  background-color: #e7e7e7; 
}

.preferences button.selected {
  background-color: #DFE287;; 
  color: #303030;
}


.search-input-wrapper {
  position: relative; /* Establishes positioning context */
  width: 80%; /* Or adjust as needed to match input field width */
  margin-bottom: 1rem; /* Add margin below the wrapper if needed */
}

/* Ensure InputField takes appropriate width */
/* You might need to target the actual input within InputField if it's nested */
.search-input-wrapper > :deep(input), /* Example if InputField renders a root input */
.search-input-wrapper .InputField /* Example if InputField has a class */
 {
    width: 100%;
    box-sizing: border-box; /* Include padding/border in width */
     margin: 0 !important; /* Override inline style if needed */
}


/* *** ADJUSTED STYLE for the results container *** */
.search-results-container {
  position: absolute;
  top: 100%; /* Position below the wrapper (adjust if input has different height) */
  left: 0;
  width: 100%; /* Make it same width as the wrapper */
  /* right: 0; */ /* Remove right: 0 */
  background: white;
  border-radius: 10px;
  border: 1px solid #303030;
  max-height: 200px;
  overflow-y: auto;
  z-index: 10;
  /* margin: 0.5rem; */ /* Remove margin, use wrapper margin if needed */
  margin-top: 4px; /* Optional: small gap between input and dropdown */
  padding: 0.5rem;
  box-sizing: border-box; /* Include padding/border in width */
  box-shadow: 0 4px 6px rgba(0,0,0,0.1); /* Optional: add shadow */
}


.result-item {
  padding: 0.8rem;
  cursor: pointer;
  border-radius: 8px;
  margin-bottom: 0.5rem;
  transition: background-color 0.2s;
}

.result-item:hover {
  background-color: #F2E6DD;
}

.main-text {
  font-family: 'Asap', sans-serif;
  font-weight: bold;
  color: #303030;
}

.hyphen {
  margin: 0 0.2rem;
}

.secondary-text {
  font-family: 'Asap', sans-serif;
  color: #666;
  font-size: 0.9em; /* Slightly smaller */
}


.form-wrapper {
    display: flex;
  overflow: hidden;
    flex-direction: column;
    align-items: center;
}
.personalization-area {
  width: 90%; /* Adjusted width slightly */
  min-height: 300px;
  /* max-height: calc(90vh - 12rem); */ /* Max height might conflict with overflow */
  border-radius: 10px;
  border: 1px solid #303030;
  background: #F2E6DD;
  transition: all 0.3s ease-in-out;
  padding: 1.5rem;
  margin-bottom: 1rem;
  /* overflow-y: auto; */ /* Let content dictate height, or manage overflow carefully */
  box-shadow: none;
  display: flex; /* Use flex for better internal alignment */
  flex-direction: column;
  align-items: center; /* Center content like input wrapper */
}


.personalization-container {
  display: none; /* Keep hidden unless active */
  width: 100%;
  /* height: 100%; */ /* Let content define height */
}

.personalization-container.active {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100%; /* Ensure it takes full width of parent */
}

.personalization-container h2 {
  font-size: 1.5rem;
  color: #303030;
  margin-bottom: 1.5rem;
  font-family: 'Recoleta', serif;
  font-weight: bold;
}

.button-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: space-between;
  /* height: 100%; */ /* Remove fixed height */
  min-height: 150px; /* Adjust as needed */
  padding: 1.5rem 0;
}

.arrow-button-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
}

.s-button-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
}

.s-button-wrapper button {
  padding: 0.8rem 1.5rem;
  font-size: 1rem;
  min-width: 100px;
}

.s-button-wrapper button:first-child {
  color: #303030;
  background: #FAC54B;
  border-radius: 10px;
}

.s-button-wrapper button:nth-child(2) {
  color: #F2E6DD;
  background: #B21C29;
  border-radius: 10px;
}

.preferences {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  justify-content: center;
  margin-top: 1rem;
}

.area-3-organizer {
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: space-between;
  width: 100%;
  padding: 2rem;
}

.language-selection,
.region-detection {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  width: 100%;
  align-items: center;
  margin-top: 1rem;
}

.languages,
.region {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 1rem;
}

.region-label {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 1rem;
}

.search-results-container {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border-radius: 10px;
  border: 1px solid #303030;
  max-height: 200px;
  overflow-y: auto;
  z-index: 10;
  margin: 0.5rem;
  padding: 0.5rem;
}

.result-item {
  padding: 0.8rem;
  cursor: pointer;
  border-radius: 8px;
  margin-bottom: 0.5rem;
  transition: background-color 0.2s;
  text-align: left; /* Ensure text aligns left */
}

.result-item:hover {
  background-color: #F2E6DD;
}

.sign-up.form {
  width: 360px;
  transform: translateY(0%);
  opacity: 1;
  transition: all 0.3s ease-in-out;
}


.sign-up.form.concluded {
  transform: translateY(-20px);
  opacity: 0;
}

.personalization.form-wrapper {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: -1;
  display: flex;
  align-items: center;
  justify-content: center;
  width: auto;
  height: auto;
  max-height: 90vh;
  overflow-y: auto;
  pointer-events: none;
  /* Remove any border from wrapper */
  border: none;
  border-radius: 0;
}

.personalization.form-wrapper.active {
  z-index: 2;
  pointer-events: auto;
}

.personalization.form {
  width: 500px;
  transform: translateY(20px);
  opacity: 0;
  transition: all 0.3s ease-in-out;
  display: flex;
  flex-direction: column;
  align-items: center;
  background: #F2CAAC;
  padding: 2rem;
  border-radius: 30px;
  border: 1px solid #303030;
  max-height: calc(90vh - 4rem);
  overflow-y: auto;
  /* Add box-shadow for depth instead of multiple borders */
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.personalization.form.active {
  transform: translateY(0);
  opacity: 1;
}

.personalization-form-wrapper {
  display: flex;
  gap: 1rem;
  width: 100%;
  align-items: stretch; /* Changed from center to stretch to allow children to expand */
  justify-content: center;
  margin-bottom: 1.5rem;
}

.terms-checkbox {
  display: flex;
  align-items: flex-start;
  justify-content: flex-start;
  margin-bottom: 1rem;
}

.terms-checkbox input[type="checkbox"] {
  margin-right: 0.6rem;
  width: 5%;
}

.terms-checkbox label {
  font-size: 0.9rem;
  color: #303030;
  text-align: left;
  word-break: keep-all; /* Prevents breaking words at character level */
  hyphens: auto; /* Allows breaking words at appropriate hyphenation points */
}

.terms-checkbox a {
  color: #0000EE; /* Standard link color */
  font-size: 0.9rem;
  text-decoration: none;
}

.terms-checkbox a:hover {
  text-decoration: underline;
}

.sign-up-wrapper {
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: flex-start;
  width: 100%;
  gap: 0.5rem;
}

.sign-up-wrapper button[type="submit"] {
  flex: 1;
  padding: 1rem;
  background-color: #FAC54B;
  color: #303030;
  font-size: 1.2rem;
  border: 1px solid #303030;
}

.social-sign-up {
  width: 48px;
  height: 48px;
  padding: 0.8rem;
  background-color: white;
  border: 1px solid #303030;
  border-radius: 10px;
  flex-shrink: 0;
}

.terms-checkbox {
  margin: 1.5rem 0;
}

.terms-checkbox input[type="checkbox"] {
  width: 20px;
  height: 20px;
  margin-right: 1rem;
  accent-color: #FAC54B;
}

.terms-checkbox label {
  font-size: 0.9rem;
  line-height: 1.4;
}

.terms-checkbox a {
  color: #E65E2A;
  text-decoration: underline;
}

.input-container {
  margin-bottom: 1.2rem;
}

.button-wrapper {
  display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    width: fit-content;
}


.arrow-button-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.personalization-arrow:first-child {
  margin-bottom: 1rem;
}
.personalization-arrow {
  fill: #49ABFB;
}

.s-button-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
}
.s-button-wrapper button:first-child {
 color: #303030;
background: #F2E6DD;
width: 5rem;
  border-radius: 10px;
}

.s-button-wrapper button:nth-child(2) {
 color: #F2E6DD;
 background: #B21C29;
 margin-bottom: 0;
   width: 5rem;
  border-radius: 10px;
}


.social-sign-up-wrapper {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 28%;
}

.form {
  background: #F2CAAC;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  padding: 2rem;
  border-radius: 30px;
  border: 1px solid #303030;
  text-align: left;
  width: 360px;
  box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
  margin-bottom: 2rem;
}

.form h1 {
  color: #303030;
  font-size: 2.5rem;
  margin-bottom: 2rem;
  text-align: left;
  font-family: 'Recoleta', serif;
  font-weight: bold;
}

.input-container {
  margin-bottom: 1rem;
  width: 100%;
}

input {
  width: calc(100% - 2rem);
  padding: 1rem;
}

.sign-up-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 100%;
  gap: 1rem;
}

.social-sign-up-wrapper {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  width: 100%;
  margin: 1rem 0;
}

.social-sign-up {
  width: 3rem;
  height: 3rem;
  padding: 0.5rem;
  background-color: white;
  border: 1px solid #303030;
  border-radius: 10px;
}

.buttons-row {
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: flex-start;
  width: 100%;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.buttons-row button[type="submit"] {
  flex: 1;
  padding: 1rem;
  background-color: #FAC54B;
  color: #303030;
  font-size: 1.2rem;
  border: 1px solid #303030;
}

.social-sign-up {
  width: 48px;
  height: 48px;
  padding: 0.8rem;
  background-color: white;
  border: 1px solid #303030;
  border-radius: 10px;
  flex-shrink: 0;
}

.gamification-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
  width: 100%;
  margin-bottom: 2rem;

}

.gamification-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2rem;
  width: 100%;
}

.avatar-main {
  display: flex;
  justify-content: center;
  width: 100%;
}

.default-avatar {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  border: 2px solid #303030;
  transition: background-color 0.3s ease;
}

.avatar-options {
  display: flex;
  justify-content: center;
  gap: 1.5rem;
  width: 100%;
}

.avatar-option {
  cursor: pointer;
  transition: transform 0.2s ease;
}

.avatar-option:hover {
  transform: scale(1.1);
}

.avatar-circle {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  border: 2px solid #303030;
}

.selected-avatar .avatar-circle {
  border: 3px solid #DFE287;
}

.gamification-toggle {
  width: 50px;
  height: 25px;
  background-color: #ccc;
  border-radius: 15px;
  cursor: pointer;
  position: relative;
  transition: all 0.3s ease;
}

.toggle-circle {
  width: 19px;
  height: 19px;
  background-color: white;
  border-radius: 50%;
  position: absolute;
  top: 2px;
  left: 2px;
  transition: all 0.3s ease;
  border: 1px solid #303030;
}

.toggle-on {
  transform: translateX(25px);
}

.gamification-toggle.on {
  background-color: #DFE287;
}

</style>   


